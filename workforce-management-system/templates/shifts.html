<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-dark.css') }}">
    <style>
    *{ box-sizing: border-box; }
    header{ position:sticky; top:0; z-index:10; }
    .nav{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 16px; }
    .nav .left{ display:flex; gap:12px; align-items:center; }
    .logo{ font-weight:700; color:var(--primary); }
    .hidden{ display:none; }
    .fullw{ width:100%; }

    main{ max-width:1100px; margin:18px auto; padding:0 12px; }

    .section{ padding:14px; }
    h1{ font-size:22px; margin:0 0 10px; }
    h2{ font-size:18px; margin:0 0 10px; }

    /* Calendar */
    .calendar{ margin-top:14px; }
    .cal-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--divider); }
    .month-label{ font-weight:700; }
    .legend{ display:flex; flex-wrap:wrap; gap:10px; padding:10px 14px; border-bottom:1px solid var(--divider); }
    .legend-item{ display:flex; align-items:center; gap:6px; font-size:12px; }
    .legend-swatch{ width:12px; height:12px; border-radius:3px; border:1px solid var(--border); display:inline-block; }
    .legend-swatch.kellie{ background: var(--event-green); }
    .legend-swatch.robin{ background: var(--event-blue); }
    .legend-swatch.scarlett{ background: var(--event-orange); }
    .legend-swatch.purple{ background: var(--event-purple); }
    .legend-swatch.cyan{ background: var(--event-cyan); }

    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); border-top:1px solid var(--divider); }
    .dow:last-child{ border-right:none; }
    .cells{ display:grid; grid-template-columns: repeat(7, 1fr); }
    .date-tag{ font-weight:700; font-size:13px; color:var(--text-1); display:flex; align-items:center; justify-content:space-between; letter-spacing:.2px; }
    .today-dot{ width:7px; height:7px; background:var(--primary); border-radius:50%; display:inline-block; margin-left:6px; }
    .pills{ margin-top:4px; display:flex; flex-direction:column; gap:4px; }
    .current-week{ box-shadow: inset 0 0 0 2px var(--focus); }

    /* Hover Add button */
    .add-btn{ position:absolute; right:6px; top:6px; font-size:11px; opacity:0; transition:opacity .15s ease; }
    .cell:hover .add-btn{ opacity:1; }

    /* Dialogs */
    .menu{ position:fixed; z-index:50; background:var(--bg-2); color:var(--text-1); border:1px solid var(--border); border-radius:8px; padding:10px; box-shadow:var(--shadow-2); width:260px; display:none; max-height:min(80vh, 420px); overflow:auto; }
    .menu h4{ margin:0 0 6px; font-size:14px; }
    .menu .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0; flex-wrap:wrap; }
    .mini-label{ font-size:12px; color:var(--text-3); }
    .mini-input{ width:100%; }
    .seg{ display:flex; gap:6px; flex-wrap:wrap; }

    .rowx{ display:flex; flex-direction:column; gap:6px; }
    .chip{ background: var(--bg-1); border:1px solid var(--border); padding:4px 8px; border-radius:16px; font-size:12px; cursor:pointer; color: var(--text-1); }
    .chip input{ margin-right:6px; }
    .muted{ color:var(--text-3); font-size:13px; }

    /* Add a little spacing for inline time selects */
    .time-selects{ display:flex; gap:6px; align-items:center; }

    .is-hidden{ display:none !important; }
    .emp-btn.active{ background: var(--primary); color:#fff; border-color: var(--primary); }
    </style>
</head>
<body>
<header>
    <nav class="nav">
        <div class="left">
            <span class="logo">Care Calendar</span>
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('employees') }}">Employees</a>
            <a href="{{ url_for('shifts') }}">Shifts</a>
            <a href="{{ url_for('attendance') }}">Attendance</a>
            <a href="{{ url_for('tasks') }}">Tasks</a>
            <a href="{{ url_for('performance') }}">Performance</a>
            <a href="{{ url_for('hours_report') }}">Hours</a>
        </div>
        <div class="right">
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>
</header>
<main>
    <section class="card section">
        <h1>Shift Scheduling</h1>
        <div class="rowx">
            <div class="seg">
              <button class="btn btn-primary" id="btnNewShift">New Shift</button>
              <button class="btn btn-secondary" id="btnSelectMode">Select shifts</button>
              <button class="btn btn-danger hidden" id="btnDeleteSelected">Delete selected (0)</button>
            </div>
            <form id="addShiftForm" action="{{ url_for('shifts') }}" method="post" onsubmit="return validateShiftForm()">
                <input type="hidden" id="employee_id_select" name="employee_id" required>
                <input type="hidden" id="shift_time_input" name="shift_time" required>
                <input type="hidden" id="end_time_input" name="end_time">
                <input type="hidden" id="repeat_until_input" name="repeat_until">
                <!-- selected_days and repeat_weekly will be injected dynamically -->
                <button class="btn btn-primary hidden" type="submit" id="addShiftBtn">Add Shift</button>
            </form>
        </div>
    </section>

    <section class="card calendar">
        <div class="cal-head">
            <div class="btn-group">
                <button class="btn btn-secondary" id="prevPeriod" aria-label="Previous">« Prev</button>
                <button class="btn btn-secondary" id="todayBtn" aria-label="Current">Today</button>
                <button class="btn btn-secondary" id="nextPeriod" aria-label="Next">Next »</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="viewMonth">Month</button>
                <button class="btn btn-secondary" id="viewWeek">Week</button>
            </div>
            <div class="month-label" id="periodLabel"></div>
        </div>
        <div class="legend" id="calendarLegend" aria-label="Employee color legend"></div>
        <div class="grid">
            <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
        </div>
        <div class="cells" id="grid"></div>
    </section>

  <div class="menu" id="shiftMenu" role="dialog" aria-modal="true" aria-labelledby="menuTitle" tabindex="-1">
        <h4 id="menuTitle">Shift</h4>
    <div class="row"><button class="btn btn-danger" id="btnDeleteShift">Delete shift</button><button class="btn btn-secondary hidden" id="btnDeleteSeries">Delete series</button></div>
        <div class="row">
      <select id="swapSelect" class="select"><option value="">Swap to…</option></select>
      <button class="btn btn-primary" id="btnSwap">Swap</button>
        </div>
        <!-- Replace bulky inline update UI with a single button that opens a wizard -->
        <div class="row is-hidden" id="editSeriesRow">
            <div class="fullw">
                <div class="mini-label">Series</div>
        <button class="btn btn-primary" id="btnOpenEditSeries">Edit series…</button>
            </div>
        </div>
        <div class="row">
            <div class="fullw">
                <div class="mini-label">Coverage window</div>
                <div class="seg">
                    <!-- Replaced native time inputs with 15-min selects -->
                    <div class="time-selects" aria-label="Coverage start">
            <select id="covStartHour" aria-label="Start hour" class="select">
                        <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                      </select>
                      <span>:</span>
            <select id="covStartMin" aria-label="Start minutes" class="select">
                        <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                      </select>
                    </div>
                    <div class="time-selects" aria-label="Coverage end">
            <select id="covEndHour" aria-label="End hour" class="select">
                        <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                      </select>
                      <span>:</span>
            <select id="covEndMin" aria-label="End minutes" class="select">
                        <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                      </select>
                    </div>
          <button class="btn btn-secondary" id="btnSaveCoverage">Save</button>
                </div>
            </div>
        </div>
        <div class="footer-links">
      <button class="btn btn-secondary" id="btnCloseMenu">Close</button>
        </div>
    </div>

    <!-- Wizard Modal -->
    <div class="overlay" id="wizardOverlay" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
      <div class="modal" id="wizardModal">
        <div class="hd" id="wizTitle">Create Shift</div>
        <div class="bd">
          <div class="step" id="step1">
            <div class="rowx">
              <label>Employee</label>
              <div id="wizEmployeeList" class="seg"></div>
            </div>
          </div>
          <div class="step hidden" id="step2">
            <div class="rowx">
              <label for="wizStartDate">Start date & time</label>
              <div class="time-selects">
                <input type="date" id="wizStartDate" class="input">
                <select id="wizStartHour12" aria-label="Start hour" class="select">
                  <option value="">HH</option>
                  <option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09" selected>09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                </select>
                <span>:</span>
                <select id="wizStartMin" aria-label="Start minutes" class="select">
                  <option value="">MM</option>
                  <option value="00" selected>00</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="45">45</option>
                </select>
                <select id="wizStartAmPm" aria-label="Start AM/PM" class="select"><option value="AM" selected>AM</option><option value="PM">PM</option></select>
              </div>
            </div>
            <div class="rowx">
              <label for="wizEndHour">End time (optional)</label>
              <div class="time-selects">
                <select id="wizEndHour12" aria-label="End hour" class="select">
                  <option value="">HH</option>
                  <option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                </select>
                <span>:</span>
                <select id="wizEndMin" aria-label="End minutes" class="select">
                  <option value="">MM</option>
                  <option value="00">00</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="45">45</option>
                </select>
                <select id="wizEndAmPm" aria-label="End AM/PM" class="select"><option value="AM">AM</option><option value="PM">PM</option></select>
              </div>
            </div>
            <!-- Moved repeat controls into this step to keep all scheduling on one screen -->
            <div class="rowx">
              <label><input type="checkbox" id="wizRepeat"> Repeat weekly</label>
            </div>
            <div class="rowx hidden" id="wizDaysCtn">
              <label>Weekdays</label>
              <div class="seg" id="wizDays"></div>
            </div>
            <div class="rowx hidden" id="wizUntilCtn">
              <label>Repeat until (optional)</label>
              <input type="date" id="wizUntil" class="input">
              <div class="muted">Defaults to end of year if empty.</div>
            </div>
          </div>
          <!-- step3 becomes the Review step -->
          <div class="step hidden" id="step3">
            <div class="rowx">
              <strong>Review</strong>
              <div id="wizReview" class="muted"></div>
            </div>
          </div>
          <!-- step4 removed -->
        </div>
        <div class="ft">
          <button class="btn btn-secondary" id="wizCancel">Cancel</button>
          <button class="btn btn-secondary hidden" id="wizBack">Back</button>
          <button class="btn btn-primary" id="wizNext">Next</button>
        </div>
      </div>
    </div>

    <!-- Edit Series Wizard Modal -->
    <div class="overlay is-hidden" id="editSeriesOverlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal" id="editSeriesModal">
        <div class="hd" id="editTitle">Edit Series</div>
        <div class="bd">
          <div class="step" id="eStep1">
            <div class="rowx">
              <label>Scope</label>
              <div class="muted">Changes apply to future occurrences in this series starting this week.</div>
            </div>
            <div class="rowx">
              <label for="eEmployee">Reassign caregiver (optional)</label>
              <select id="eEmployee" class="select"><option value="">Keep current</option></select>
            </div>
          </div>
          <div class="step hidden" id="eStep2">
            <div class="rowx">
              <label>Start time</label>
              <div class="time-selects">
                <select id="eStartHour" aria-label="Start hour" class="select">
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="eStartMin" aria-label="Start minutes" class="select">
                  <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>
            <div class="rowx">
              <label>End time (optional)</label>
              <div class="time-selects">
                <select id="eEndHour" aria-label="End hour" class="select">
                  <option value="">HH</option>
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="eEndMin" aria-label="End minutes" class="select">
                  <option value="">MM</option>
                  <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>
          </div>
          <div class="step hidden" id="eStep3">
            <div class="rowx">
              <label>Weekdays</label>
              <div class="seg" id="eDays"></div>
            </div>
          </div>
          <div class="step hidden" id="eStep4">
            <div class="rowx">
              <label>Repeat until (optional)</label>
              <input type="date" id="eUntil" class="mini-input">
              <div class="muted">Defaults to end of year if empty.</div>
            </div>
          </div>
          <div class="step hidden" id="eStep5">
            <div class="rowx">
              <strong>Review</strong>
              <div id="eReview" class="muted"></div>
            </div>
          </div>
        </div>
        <div class="ft">
          <button class="btn btn-secondary" id="eCancel">Cancel</button>
          <button class="btn btn-secondary hidden" id="eBack">Back</button>
          <button class="btn btn-primary" id="eNext">Next</button>
        </div>
      </div>
    </div>
</main>

<script id="shifts-data" type="application/json">{{ shifts | tojson }}</script>
<script id="employees-data" type="application/json">{{ employees | tojson }}</script>
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>
<script>
// --- Utilities ---
function pad2(n){ return String(n).padStart(2,'0'); }
function localDateStr(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function startOfWeek(d){ const x=new Date(d); const w=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-w); return x; }
function startOfMonth(d){ const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function hashString(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } return Math.abs(h); }
function nameToEventClass(name){ const n=name.toLowerCase(); if(n.includes('kellie')) return 'kellie'; if(n.includes('robin')) return 'robin'; if(n.includes('scarlett')) return 'scarlett'; const pool=['purple','cyan']; return pool[hashString(name)%pool.length]; }
// Ensure form validation handler exists (wizard handles validation already)
function validateShiftForm(){ return true; }

// --- Data ---
const shiftsData = JSON.parse(document.getElementById('shifts-data').textContent);
const employeesData = JSON.parse(document.getElementById('employees-data').textContent);
const API = {
  deleteShift: "{{ url_for('api_delete_shift') }}",
  deleteSeries: "{{ url_for('api_delete_series') }}",
  swapShift: "{{ url_for('api_swap_shift') }}",
  updateSeries: "{{ url_for('api_update_series') }}"
};

// Pre-index shifts by YYYY-MM-DD for faster rendering
function buildDayIndex(shifts){
  const idx = {};
  for(const s of shifts){
    const day = s.shift_time.slice(0,10);
    (idx[day] ||= []).push(s);
  }
  return idx;
}
const dayIndex = buildDayIndex(shiftsData);

// Coverage prefs
function getCov(){ try{ const s=localStorage.getItem('cov'); if(!s) return { a:540, b:1260 }; const {a,b}=JSON.parse(s); return { a, b }; }catch{ return { a:540, b:1260 }; } }
function setCov(a,b){ localStorage.setItem('cov', JSON.stringify({a,b})); }
function minsFromHHMM(t){ const [hh,mm]=t.split(':').map(x=>parseInt(x,10)||0); return hh*60+mm; }

// --- Legend ---
function buildLegend(){
  const legend = document.getElementById('calendarLegend'); legend.innerHTML='';
  const names=[...new Set(shiftsData.map(s=>s.name))].sort((a,b)=>a.localeCompare(b));
  names.forEach(n=>{ const cls=nameToEventClass(n); const item=document.createElement('div'); item.className='legend-item'; const sw=document.createElement('span'); sw.className='legend-swatch '+cls; const label=document.createElement('span'); label.textContent=n; item.append(sw,label); legend.appendChild(item); });
}

// --- Views ---
let view = (function(){
  const saved = localStorage.getItem('view');
  if(saved) return saved;
  const v = window.innerWidth < 800 ? 'week' : 'month';
  localStorage.setItem('view', v);
  return v;
})();
let anchor = new Date();

function render(){
  if(view==='month') buildMonth(); else buildWeek();
}

function buildMonth(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const today=new Date(anchor);
  const shown=new Date(today.getFullYear(), today.getMonth(), 1);
  const monthStart=startOfMonth(shown);
  const firstCell=startOfWeek(monthStart); // Monday alignment
  const label=document.getElementById('periodLabel'); label.textContent = shown.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  const currentWeekStart=startOfWeek(new Date());
  for(let i=0;i<42;i++) renderDayCell(addDays(firstCell,i), shown.getMonth(), currentWeekStart, grid);
}

function buildWeek(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const weekStart=startOfWeek(anchor);
  const label=document.getElementById('periodLabel');
  const weekEnd=addDays(weekStart,6);
  label.textContent = `${weekStart.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${weekEnd.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
  for(let i=0;i<7;i++) renderDayCell(addDays(weekStart,i), weekStart.getMonth(), weekStart, grid);
}

function renderDayCell(day, shownMonth, currentWeekStart, grid){
  const cell=document.createElement('div'); cell.className='cell';
  if(day.getMonth()!==shownMonth) cell.classList.add('dim');
  const isCurrentWeek = startOfWeek(day).getTime()===currentWeekStart.getTime();
  if(isCurrentWeek) cell.classList.add('current-week');
  const today = new Date(); today.setHours(0,0,0,0);
  const isToday = day.getTime()===today.getTime();
  if(isToday) cell.classList.add('today-cell');

  const dateTag=document.createElement('div'); dateTag.className='date-tag';
  const dateNum=document.createElement('span'); dateNum.textContent=fmtDayLabel(day);
  const todayBadge=document.createElement('span'); if(isToday){ todayBadge.className='today-dot'; }
  dateTag.appendChild(dateNum); if(isToday) dateTag.appendChild(todayBadge); cell.appendChild(dateTag);
  // Add hover button to create shift
  const add=document.createElement('button'); add.className='add-btn'; add.type='button'; add.textContent='Add';
  add.addEventListener('click', (e)=>{ e.stopPropagation(); openWizardWithDate(day); });
  cell.appendChild(add);
  const pills=document.createElement('div'); pills.className='pills'; cell.appendChild(pills);

  const dayStr=localDateStr(day);
  const items = dayIndex[dayStr] || [];
  const dayShifts = items.map(s=>({
      id:s.id, name:s.name, start:new Date(s.shift_time), end: s.end_time ? new Date(`${dayStr}T${s.end_time.slice(11,16)}`) : null, series_id:s.series_id, employee_id:s.employee_id
  }));

  // Coverage gap check using configurable window
  const cov=getCov(); const ATT_START=cov.a, ATT_END=cov.b;
  let intervals=[];
  for(const sh of dayShifts){
      const st=sh.start.getHours()*60 + sh.start.getMinutes();
      const et=sh.end ? sh.end.getHours()*60 + sh.end.getMinutes() : (st+60);
      const a=Math.max(ATT_START, st), b=Math.min(ATT_END, et);
      if(b>a) intervals.push([a,b]);
  }
  intervals.sort((x,y)=>x[0]-y[0]);
  let merged=[]; for(const iv of intervals){ if(!merged.length || iv[0]>merged[merged.length-1][1]) merged.push(iv); else merged[merged.length-1][1]=Math.max(merged[merged.length-1][1], iv[1]); }
  let covered=0; merged.forEach(([a,b])=> covered+= (b-a));
  if(covered < (ATT_END-ATT_START)){
  const badge=document.createElement('span'); badge.className='gap-badge'; badge.textContent='Coverage gap'; cell.classList.add('needs-attention'); cell.appendChild(badge);
  }

  dayShifts.forEach(sh=>{
      const cls=nameToEventClass(sh.name);
      const ev=document.createElement('div'); ev.className='event '+cls;
      const timelabel = `${to12h(sh.start)}${sh.end? '–'+to12h(sh.end): ''}`;
      ev.innerHTML = `<span>${timelabel} ${sh.name}</span>`;
      ev.dataset.shiftId=sh.id; ev.dataset.seriesId=sh.series_id||''; ev.dataset.employeeId=sh.employee_id;
      ev.addEventListener('click', (e)=>{ e.stopPropagation(); if(selectionMode){ toggleSelect(ev, sh.id, sh.series_id); } else { openMenu(e, sh); } });
      ev.addEventListener('contextmenu', (e)=>{ e.preventDefault(); e.stopPropagation(); if(selectionMode){ toggleSelect(ev, sh.id, sh.series_id); } else { openMenu(e, sh); } });
      pills.appendChild(ev);
  });

  grid.appendChild(cell);
}

// --- Selection mode & batch delete ---
let selectionMode=false;
const selected=new Set();
const selectedMap=new Map(); // id -> series_id|null
function updateDeleteSelectedLabel(){ const b=document.getElementById('btnDeleteSelected'); if(b) b.textContent=`Delete selected (${selected.size})`; }
function toggleSelect(pill, id, seriesId){ if(selected.has(id)){ selected.delete(id); selectedMap.delete(id); pill.classList.remove('selected'); } else { selected.add(id); selectedMap.set(id, seriesId||null); pill.classList.add('selected'); } updateDeleteSelectedLabel(); }

document.getElementById('btnSelectMode').addEventListener('click', ()=>{
  selectionMode = !selectionMode;
  document.getElementById('btnDeleteSelected').classList.toggle('hidden', !selectionMode);
  document.getElementById('btnSelectMode').textContent = selectionMode ? 'Cancel selection' : 'Select shifts';
  selected.clear(); selectedMap.clear(); updateDeleteSelectedLabel();
  document.querySelectorAll('.pill.selected').forEach(el=> el.classList.remove('selected'));
});

document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{
  if(!selected.size) return alert('No shifts selected');
  const hasSeries = [...selectedMap.values()].some(v=>!!v);
  let deleteSeriesToo=false;
  if(hasSeries){
    deleteSeriesToo = confirm('Some selected shifts are part of a series. Press OK to delete entire series for those; Cancel to delete only selected occurrences.');
  }
  try{
    const ops=[];
    if(deleteSeriesToo){
      const seriesIds=[...new Set([...selectedMap.values()].filter(Boolean))];
      seriesIds.forEach(sid=> ops.push(postJSON(API.deleteSeries, { series_id: sid })));
      const singles=[...selectedMap.entries()].filter(([id,sid])=>!sid).map(([id])=>id);
      singles.forEach(id=> ops.push(postJSON(API.deleteShift, { shift_id: id })));
    } else {
      [...selected].forEach(id=> ops.push(postJSON(API.deleteShift, { shift_id: id })));
    }
    await Promise.all(ops);
    location.reload();
  }catch(e){ alert('Failed to delete selected: '+e.message); }
});

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && selectionMode){ document.getElementById('btnSelectMode').click(); }});

// --- Menu ---
let currentShift=null;
const menu=document.getElementById('shiftMenu');
let menuAnchor = { x: 0, y: 0 };
// Ensure positioning helper exists before use
function positionMenuNear(x, y){
  if(!menu) return;
  // Show to measure
  menu.style.display='block';
  // Reset first to get accurate size
  menu.style.left='0px';
  menu.style.top='0px';
  const rect = menu.getBoundingClientRect();
  const w = rect.width || menu.offsetWidth;
  const h = rect.height || menu.offsetHeight;
  const pad = 8;
  const left = Math.min(Math.max(pad, (typeof x==='number'? x : pad)), Math.max(pad, window.innerWidth - w - pad));
  const top = Math.min(Math.max(pad, (typeof y==='number'? y : pad)), Math.max(pad, window.innerHeight - h - pad));
  menu.style.left = left + 'px';
  menu.style.top = top + 'px';
}
function openMenu(evt, sh){
  currentShift=sh;
  document.getElementById('menuTitle').textContent = `${sh.name} • ${sh.start.toLocaleString()}`;
  const btnSeries=document.getElementById('btnDeleteSeries'); btnSeries.classList.toggle('hidden', !sh.series_id);
  // Show/hide Edit Series row based on whether this is part of a series
  const editRow = document.getElementById('editSeriesRow'); if(editRow){ editRow.classList.toggle('is-hidden', !sh.series_id); }
  const sel=document.getElementById('swapSelect'); sel.innerHTML='<option value="">Swap to…</option>' + employeesData.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
  // Prefill coverage window selects from stored minutes
  const cov=getCov();
  const shh = pad2(Math.floor(cov.a/60)), smm = pad2(cov.a%60);
  const ehh = pad2(Math.floor(cov.b/60)), emm = pad2(cov.b%60);
  const csH=document.getElementById('covStartHour'), csM=document.getElementById('covStartMin');
  const ceH=document.getElementById('covEndHour'), ceM=document.getElementById('covEndMin');
  if(csH) csH.value = shh; if(csM) csM.value = smm;
  if(ceH) ceH.value = ehh; if(ceM) ceM.value = emm;
  // Position within viewport
  menuAnchor = { x: evt.clientX, y: evt.clientY };
  positionMenuNear(menuAnchor.x, menuAnchor.y);
  // focus for accessibility
  menu.setAttribute('tabindex','-1');
  menu.focus();
}
function closeMenu(preserveShift=false){ menu.style.display='none'; if(!preserveShift) currentShift=null; }

async function postJSON(url, payload){
  const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  if(!res.ok){ const t=await res.text(); throw new Error(t); }
  return res.json();
}

// --- Menu ---
// Replace Delete button node to clear any prior listeners, then attach series-aware delete
(function(){
  const oldBtn = document.getElementById('btnDeleteShift');
  if(oldBtn){
    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);
    newBtn.addEventListener('click', async ()=>{
      if(!currentShift) return;
      try{
        if(currentShift.series_id){
          const all = confirm('This shift is part of a series. Press OK to delete the entire series, or Cancel to delete only this occurrence.');
          if(all){ await postJSON(API.deleteSeries, { series_id: currentShift.series_id }); }
          else { await postJSON(API.deleteShift, { shift_id: currentShift.id }); }
        } else {
          await postJSON(API.deleteShift, { shift_id: currentShift.id });
        }
        location.reload();
      }catch(e){ alert('Failed to delete: '+e.message); }
    });
  }
})();

document.getElementById('btnDeleteSeries').addEventListener('click', async ()=>{
  if(!currentShift || !currentShift.series_id) return; if(!confirm('Delete the entire series?')) return;
  try{ await postJSON(API.deleteSeries, { series_id: currentShift.series_id }); location.reload(); }catch(e){ alert('Failed to delete series: '+e.message); }
});

document.getElementById('btnSwap').addEventListener('click', async ()=>{
  if(!currentShift) return; const sel=document.getElementById('swapSelect'); const val=sel.value; if(!val) return alert('Select a caregiver to swap to');
  try{ await postJSON(API.swapShift, { shift_id: currentShift.id, new_employee_id: parseInt(val,10) }); location.reload(); }catch(e){ alert('Failed to swap: '+e.message); }
});

// Remove legacy inline series update handler if element not present
(function(){
  const btn = document.getElementById('btnUpdateSeries');
  if(btn){
    btn.addEventListener('click', async ()=>{
      if(!currentShift || !currentShift.series_id) return alert('Series not available');
      const time = document.getElementById('seriesTime').value; if(!time) return alert('Time required');
      const end = document.getElementById('seriesEnd').value; const until = document.getElementById('seriesUntil').value || null;
      const wds = Array.from(document.querySelectorAll('.series-wd:checked')).map(el=>parseInt(el.value,10)); if(!wds.length) return alert('Select weekdays');
      const startDate = localDateStr(startOfWeek(currentShift.start));
      try{ await postJSON(API.updateSeries, { series_id: currentShift.series_id, start_date: startDate, time, end_time:end||null, weekdays:wds, repeat_until: until }); location.reload(); }catch(e){ alert('Failed to update series: '+e.message); }
    });
  }
})();

document.getElementById('btnSaveCoverage').addEventListener('click', ()=>{
  // Read 15-min dropdowns
  const sh = document.getElementById('covStartHour').value || '09';
  const sm = document.getElementById('covStartMin').value || '00';
  const eh = document.getElementById('covEndHour').value || '21';
  const em = document.getElementById('covEndMin').value || '00';
  const a = parseInt(sh,10)*60 + parseInt(sm,10);
  const b = parseInt(eh,10)*60 + parseInt(em,10);
  if(b<=a) return alert('Coverage end must be after start');
  setCov(a,b); closeMenu(); render();
});

document.getElementById('btnCloseMenu').addEventListener('click', ()=> closeMenu());
window.addEventListener('click', (e)=>{ if(menu.style.display==='block' && !menu.contains(e.target) && !e.target.closest('.pill')) { if(typeof eOverlay !== 'undefined' && eOverlay && eOverlay.style.display==='flex' && !eOverlay.classList.contains('is-hidden')) closeMenu(true); else closeMenu(); } });
window.addEventListener('resize', ()=>{ if(menu.style.display==='block'){ positionMenuNear(menuAnchor.x, menuAnchor.y); } });

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(menu.style.display==='block') closeMenu();
    else if(overlay && overlay.style.display==='flex') closeWizard();
    else if(typeof eOverlay !== 'undefined' && eOverlay && !eOverlay.classList.contains('is-hidden')) eClose();
  }
});

// --- Wizard ---
const overlay = document.getElementById('wizardOverlay');
const wiz = { step:1, employeeId:null, start:null, end:null, repeat:false, days:new Set(), until:null };

function showStep(n){
  wiz.step=n;
  for(let i=1;i<=3;i++) document.getElementById('step'+i).classList.toggle('hidden', i!==n);
  document.getElementById('wizBack').classList.toggle('hidden', n===1);
  document.getElementById('wizNext').textContent = (n===3?'Create':'Next');
  if(n===3) buildReview();
}

function openWizard(){
  // Build employee button list
  const list = document.getElementById('wizEmployeeList');
  if(list){
    list.innerHTML = '';
    employeesData.forEach(e=>{
      const b=document.createElement('button');
      b.type='button'; b.className='chip emp-btn'; b.textContent=e.name; b.dataset.id=e.id; b.setAttribute('aria-pressed','false');
      b.addEventListener('click', ()=>{
        // clear previous selection
        list.querySelectorAll('.emp-btn').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
        b.classList.add('active'); b.setAttribute('aria-pressed','true'); wiz.employeeId = String(e.id);
      });
      list.appendChild(b);
    });
  }
  // Build weekdays once
  const daysCtn=document.getElementById('wizDays');
  if(daysCtn && !daysCtn.dataset.built){
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    labels.forEach((lb,idx)=>{ const lab=document.createElement('label'); lab.className='chip'; lab.innerHTML=`<input type="checkbox" value="${idx}"> ${lb}`; daysCtn.appendChild(lab); });
    daysCtn.dataset.built='1';
  }
  overlay.style.display='flex';
  setTimeout(()=>{ try{ const firstBtn=list && list.querySelector('.emp-btn'); if(firstBtn) firstBtn.focus(); }catch{} }, 0);
  showStep(1);
}
function closeWizard(){ overlay.style.display='none'; }

function openWizardWithDate(day){
  openWizard();
  // Prefill the date controls
  const dStr = `${day.getFullYear()}-${pad2(day.getMonth()+1)}-${pad2(day.getDate())}`;
  const dInput = document.getElementById('wizStartDate'); if(dInput){ dInput.value = dStr; }
  // Keep default 09:00 unless changed
  updateStartFromControls && updateStartFromControls();
}

function buildReview(){
  const emp = employeesData.find(e=> String(e.id)===String(wiz.employeeId));
  const startStr = wiz.start ? new Date(wiz.start).toLocaleString() : 'Not set';
  const endStr = wiz.end || 'None';
  let rec='No'; if(wiz.repeat){ const days=[...wiz.days].sort().map(d=>['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d]).join(', '); rec=`Yes • ${days || 'Base day'}${wiz.until? ' • until '+wiz.until: ''}`; }
  document.getElementById('wizReview').textContent = `${emp?emp.name:'(none)'} • ${startStr} • End ${endStr} • Repeat ${rec}`;
}

// Compute start/end from selects (15-minute increments enforced); convert 12h to 24h internally
function to24h(h12, ampm){ let h=parseInt(h12||'0',10); if(isNaN(h)) return ''; if(ampm==='AM'){ if(h===12) h=0; } else { if(h!==12) h+=12; } return pad2(h); }
function updateStartFromControls(){ const d=document.getElementById('wizStartDate').value; const hh12=document.getElementById('wizStartHour12').value; const mm=document.getElementById('wizStartMin').value; const ap=document.getElementById('wizStartAmPm').value; const hh=to24h(hh12, ap); wiz.start = (d && hh && mm) ? `${d}T${hh}:${mm}` : null; }
function updateEndFromControls(){ const hh12=document.getElementById('wizEndHour12').value; const mm=document.getElementById('wizEndMin').value; const ap=document.getElementById('wizEndAmPm').value; const hh=to24h(hh12, ap); wiz.end = (hh && mm) ? `${hh}:${mm}` : null; }

function to12h(dateObj){
  let h = dateObj.getHours();
  const m = pad2(dateObj.getMinutes());
  const am = h < 12;
  h = h % 12; if(h===0) h = 12;
  return `${h}:${m} ${am?'AM':'PM'}`;
}

function fmtDayLabel(d){
  const w = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][(d.getDay()+6)%7];
  return `${w} ${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
}

// Buttons
 document.getElementById('btnNewShift').addEventListener('click', openWizard);
 document.getElementById('wizCancel').addEventListener('click', closeWizard);
 document.getElementById('wizBack').addEventListener('click', ()=> showStep(Math.max(1, wiz.step-1)) );
 document.getElementById('wizNext').addEventListener('click', ()=>{
    if(wiz.step===1){ if(!wiz.employeeId) return alert('Select an employee'); showStep(2); return; }
    if(wiz.step===2){
      updateStartFromControls(); updateEndFromControls();
      if(!wiz.start) return alert('Pick a start date & time');
      if(wiz.end){ const st=new Date(wiz.start); const [eh,em]=wiz.end.split(':'); const et=new Date(wiz.start); et.setHours(parseInt(eh,10), parseInt(em,10), 0, 0); if(et<=st) return alert('End time must be after start'); }
      showStep(3); return;
    }
    if(wiz.step===3){
      const form=document.getElementById('addShiftForm');
      document.getElementById('employee_id_select').value = wiz.employeeId;
      document.getElementById('shift_time_input').value = wiz.start;
      document.getElementById('end_time_input').value = wiz.end || '';
      document.getElementById('repeat_until_input').value = wiz.until || '';
      // cleanup previous dynamic fields
      [...form.querySelectorAll('input[name="selected_days"]'), ...form.querySelectorAll('input[name="repeat_weekly"]')].forEach(n=>n.remove());
      if(wiz.repeat){ const rw=document.createElement('input'); rw.type='hidden'; rw.name='repeat_weekly'; rw.value='on'; form.appendChild(rw); wiz.days.forEach(d=>{ const hid=document.createElement('input'); hid.type='hidden'; hid.name='selected_days'; hid.value=String(d); form.appendChild(hid); }); }
      form.requestSubmit(); closeWizard();
    }
  });

// New event wiring for selects
['wizStartDate','wizStartHour12','wizStartMin','wizStartAmPm'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', updateStartFromControls); });
['wizEndHour12','wizEndMin','wizEndAmPm'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', updateEndFromControls); });

// Repeat controls (now on step2)
document.getElementById('wizRepeat').addEventListener('change', (e)=>{ wiz.repeat = e.target.checked; document.getElementById('wizDaysCtn').classList.toggle('hidden', !wiz.repeat); document.getElementById('wizUntilCtn').classList.toggle('hidden', !wiz.repeat); });
document.getElementById('wizDays').addEventListener('change', (e)=>{ if(e.target && e.target.type==='checkbox'){ const v=parseInt(e.target.value,10); if(e.target.checked) wiz.days.add(v); else wiz.days.delete(v); } });
document.getElementById('wizUntil').addEventListener('change', (e)=>{ wiz.until = e.target.value || null; });

// After DOM defined: prefill wiz.start from defaults on open
function prefillWizardDefaults(){ const hSel=document.getElementById('wizStartHour'); const mSel=document.getElementById('wizStartMin'); if(hSel && !hSel.value) hSel.value='09'; if(mSel && !mSel.value) mSel.value='00'; }
const _openWizard = openWizard; openWizard = function(){ _openWizard(); prefillWizardDefaults(); if(typeof updateStartFromControls==='function') updateStartFromControls(); };

// --- Init calendar controls and first render ---
(function initCalendar(){
  try{ buildLegend(); }catch(e){ console.error('Legend build failed', e); }
  try{ render(); }catch(e){ console.error('Render failed', e); }
  const prev = document.getElementById('prevPeriod');
  const next = document.getElementById('nextPeriod');
  const today = document.getElementById('todayBtn');
  const mbtn = document.getElementById('viewMonth');
  const wbtn = document.getElementById('viewWeek');
  if(prev) prev.addEventListener('click', ()=>{ anchor = (view==='month') ? new Date(anchor.getFullYear(), anchor.getMonth()-1, 1) : addDays(anchor, -7); render(); });
  if(next) next.addEventListener('click', ()=>{ anchor = (view==='month') ? new Date(anchor.getFullYear(), anchor.getMonth()+1, 1) : addDays(anchor, 7); render(); });
  if(today) today.addEventListener('click', ()=>{ anchor = new Date(); render(); });
  if(mbtn) mbtn.addEventListener('click', ()=>{ view='month'; localStorage.setItem('view','month'); render(); });
  if(wbtn) wbtn.addEventListener('click', ()=>{ view='week'; localStorage.setItem('view','week'); render(); });
})();

// --- Dark mode: hardwire to local sunset for Marietta, SC 29661 ---
// Approx coords: 35.0260°N, -82.5115°W; simple fixed sunset times by month as a heuristic.
// This avoids external APIs. Adjust as desired.
(function sunsetDarkMode(){
  const sunsetByMonth = {1:'17:35',2:'18:02',3:'19:23',4:'19:51',5:'20:17',6:'20:35',7:'20:34',8:'20:11',9:'19:31',10:'18:51',11:'17:25',12:'17:17'};
  function shouldDark(){
    try{
      const now=new Date(); const mm=now.getMonth()+1; const s=sunsetByMonth[mm]||'19:00';
      const [sh,sm]=s.split(':').map(x=>parseInt(x,10));
      const sunset=new Date(now); sunset.setHours(sh,sm,0,0);
  const sunrise=new Date(now); sunrise.setHours(6,45,0,0);
      return (now>=sunset || now<sunrise);
    }catch{ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
  }
  function apply(){ document.documentElement.classList.toggle('dark', shouldDark()); }
  apply();
  setInterval(apply, 60*1000);
})();

// --- Edit Series Wizard logic ---
const btnOpenEditSeries = document.getElementById('btnOpenEditSeries');
const eSelect = document.getElementById('eEmployee');
const eDaysCtn = document.getElementById('eDays');
const eOverlay = document.getElementById('editSeriesOverlay');
const eBackBtn = document.getElementById('eBack');
const eNextBtn = document.getElementById('eNext');
const eCancelBtn = document.getElementById('eCancel');
const eStartHour = document.getElementById('eStartHour');
const eStartMin = document.getElementById('eStartMin');
const eEndHour = document.getElementById('eEndHour');
const eEndMin = document.getElementById('eEndMin');
const eUntil = document.getElementById('eUntil');
const eReview = document.getElementById('eReview');

const eWiz = { step:1, employeeId:null, time:null, end:null, days:new Set(), until:null };

function eShowStep(n){
  eWiz.step=n;
  for(let i=1;i<=5;i++){
    const stepEl = document.getElementById('eStep'+i);
    if(stepEl) stepEl.classList.toggle('hidden', i!==n);
  }
  eBackBtn.classList.toggle('hidden', n===1);
  eNextBtn.textContent = (n===5? 'Update series' : 'Next');
  if(n===5) eBuildReview();
}

function openEditWizard(){
  if(!currentShift || !currentShift.series_id) return;
  // Hide the context menu but preserve the selected shift for the wizard flow
  if(menu && menu.style.display==='block') closeMenu(true);
  // populate employees select
  if(eSelect){
    eSelect.innerHTML = '<option value="">Keep current</option>' + employeesData.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
  }
  // build weekday chips once
  if(eDaysCtn && !eDaysCtn.dataset.built){
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    labels.forEach((lb,idx)=>{ const lab=document.createElement('label'); lab.className='chip'; lab.innerHTML=`<input type="checkbox" value="${idx}" class="e-day"> ${lb}`; eDaysCtn.appendChild(lab); });
    eDaysCtn.dataset.built='1';
    eDaysCtn.addEventListener('change', (e)=>{ if(e.target && e.target.classList.contains('e-day')){ const v=parseInt(e.target.value,10); if(e.target.checked) eWiz.days.add(v); else eWiz.days.delete(v); } });
  }
  // reset selections
  eWiz.step=1; eWiz.employeeId=null; eWiz.time=null; eWiz.end=null; eWiz.days.clear(); eWiz.until=null;
  if(eSelect) eSelect.value='';
  if(eStartHour) eStartHour.value = pad2(currentShift.start.getHours());
  if(eStartMin) eStartMin.value = pad2(currentShift.start.getMinutes());
  if(eEndHour) eEndHour.value = currentShift.end ? pad2(currentShift.end.getHours()) : '';
  if(eEndMin) eEndMin.value = currentShift.end ? pad2(currentShift.end.getMinutes()) : '';
  if(eUntil) eUntil.value = '';
  // preselect weekday of current shift
  const curWd = (currentShift.start.getDay()+6)%7; // 0=Mon
  eDaysCtn.querySelectorAll('input.e-day').forEach((cb,idx)=>{ cb.checked = (idx===curWd); if(idx===curWd) eWiz.days.add(idx); else eWiz.days.delete(idx); });

  // Explicitly show overlay (base .overlay has display:none)
  eOverlay.classList.remove('is-hidden');
  eOverlay.style.display='flex';
  eShowStep(1);
}

function eClose(){ eOverlay.classList.add('is-hidden'); eOverlay.style.display='none'; }

function eBuildReview(){
  const empId = eSelect && eSelect.value ? parseInt(eSelect.value,10) : null;
  const empName = empId ? (employeesData.find(e=>e.id===empId)||{}).name : 'Keep current';
  const timeStr = `${eStartHour.value}:${eStartMin.value}`;
  const endStr = (eEndHour.value && eEndMin.value) ? `${eEndHour.value}:${eEndMin.value}` : 'None';
  const days=[...eWiz.days].sort().map(d=>['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d]).join(', ');
  const untilStr = eUntil.value || 'End of year';
  eReview.textContent = `${empName} • ${timeStr} – ${endStr} • ${days||'none'} • until ${untilStr}`;
}

if(btnOpenEditSeries){ btnOpenEditSeries.addEventListener('click', (ev)=>{ ev.stopPropagation(); openEditWizard(); }); }
if(eCancelBtn){ eCancelBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); eClose(); }); }
if(eBackBtn){ eBackBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); eShowStep(Math.max(1, eWiz.step-1)); }); }
if(eNextBtn){ eNextBtn.addEventListener('click', async (ev)=>{
  ev.stopPropagation();
  if(eWiz.step===1){
    eWiz.employeeId = eSelect && eSelect.value ? parseInt(eSelect.value,10) : null; eShowStep(2); return;
  }
  if(eWiz.step===2){
    const sh = eStartHour ? eStartHour.value : pad2(currentShift.start.getHours());
    const sm = eStartMin ? eStartMin.value : pad2(currentShift.start.getMinutes());
    if(!sh || !sm) return alert('Pick a start time');
    if(eEndHour && eEndMin && eEndHour.value && eEndMin.value){
      const st = parseInt(sh,10)*60 + parseInt(sm,10);
      const et = parseInt(eEndHour.value,10)*60 + parseInt(eEndMin.value,10);
      if(et<=st) return alert('End must be after start');
    }
    eShowStep(3); return;
  }
  if(eWiz.step===3){ if(!eWiz.days.size) return alert('Select at least one weekday'); eShowStep(4); return; }
  if(eWiz.step===4){ eWiz.until = eUntil && eUntil.value ? eUntil.value : null; eShowStep(5); return; }
  if(eWiz.step===5){
    try{
      const startDate = (function(){ const d=new Date(currentShift.start); const w=(d.getDay()+6)%7; d.setHours(0,0,0,0); d.setDate(d.getDate()-w); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; })();
      const sh = eStartHour ? eStartHour.value : pad2(currentShift.start.getHours());
      const sm = eStartMin ? eStartMin.value : pad2(currentShift.start.getMinutes());
      const time = `${sh}:${sm}`;
      const end_time = (eEndHour && eEndMin && eEndHour.value && eEndMin.value) ? `${eEndHour.value}:${eEndMin.value}` : null;
      const payload = {
        series_id: currentShift.series_id,
        start_date: startDate,
        time,
        end_time,
        weekdays: [...eWiz.days].sort(),
        repeat_until: eWiz.until,
      };
      if(eWiz.employeeId) payload.employee_id = eWiz.employeeId;
      console.log('[EditSeries] POST', API.updateSeries, payload);
      const resp = await postJSON(API.updateSeries, payload);
      console.log('[EditSeries] response', resp);
      location.reload();
    }catch(err){ console.error('[EditSeries] failed', err); alert('Failed to update series: '+(err && err.message ? err.message : err)); }
  }
}); }

// Close edit wizard when clicking outside modal
if(eOverlay){ eOverlay.addEventListener('click', (e)=>{ if(e.target===eOverlay) eClose(); }); }
</script>
</body>
</html>