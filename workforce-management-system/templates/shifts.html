<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{ --bg:#f6f7fb; --card:#ffffff; --txt:#222; --muted:#6b7280; --brand:#1976d2; --brand-2:#1565c0; --ok:#2e7d32; --warn:#e53935; --grid-border:#e5e7eb; --pill:#e0f2fe; }
        *{ box-sizing: border-box; }
        body{ font-family: Kanit, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:var(--bg); color:var(--txt); }
        header{ background:var(--card); border-bottom:1px solid var(--grid-border); position:sticky; top:0; z-index:10; }
        .nav{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 16px; }
        .nav .left{ display:flex; gap:12px; align-items:center; }
        .logo{ font-weight:700; color:var(--brand); }
        .nav a{ color:var(--txt); text-decoration:none; padding:6px 10px; border-radius:6px; }
        .nav a:hover{ background:#f0f3f8; }
        .hidden{ display:none; }
        .fullw{ width:100%; }

        main{ max-width:1100px; margin:18px auto; padding:0 12px; }

        .card{ background:var(--card); border:1px solid var(--grid-border); border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
        .section{ padding:14px; }
        h1{ font-size:22px; margin:0 0 10px; }
        h2{ font-size:18px; margin:0 0 10px; }

        .btn{ background:var(--brand); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn:hover{ background:var(--brand-2); }
        .btn.danger{ background:#d32f2f; }
        .btn.danger:hover{ background:#b71c1c; }

        /* Calendar */
        .calendar{ margin-top:14px; }
        .cal-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--grid-border); }
        .nav-btn{ background:var(--brand); color:#fff; border:none; border-radius:6px; padding:7px 10px; cursor:pointer; }
        .nav-btn:hover{ background:var(--brand-2); }
        .month-label{ font-weight:700; }
        .legend{ display:flex; flex-wrap:wrap; gap:10px; padding:10px 14px; border-bottom:1px solid var(--grid-border); }
        .legend-item{ display:flex; align-items:center; gap:6px; font-size:12px; }
        .legend-swatch{ width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15); }

        .grid{ display:grid; grid-template-columns: repeat(7, 1fr); border-top:1px solid var(--grid-border); }
        .dow{ background:#f8fafc; color:#111827; font-weight:600; padding:8px 6px; border-right:1px solid var(--grid-border); font-size:12px; }
        .dow:last-child{ border-right:none; }
        .cells{ display:grid; grid-template-columns: repeat(7, 1fr); }
        .cell{ min-height:110px; padding:6px; border-right:1px solid var(--grid-border); border-bottom:1px solid var(--grid-border); position:relative; background:#fff; }
        .cell.dim{ background:#fafafa; color:#9ca3af; }
        .date-tag{ font-weight:600; font-size:12px; color:#111827; }
        .pills{ margin-top:4px; display:flex; flex-direction:column; gap:4px; }
        .pill{ padding:2px 4px; border-radius:6px; font-size:11px; color:#fff; display:flex; align-items:center; justify-content:space-between; gap:6px; cursor:pointer; }
        .pill small{ opacity:.9; }
        .pill.selected{ outline:2px solid #111827; box-shadow: inset 0 0 0 2px rgba(255,255,255,.6); }
        .gap-badge{ position:absolute; top:6px; right:6px; font-size:10px; background:#fdecea; color:#b71c1c; padding:2px 6px; border-radius:10px; border:1px solid #f5c6cb; }
        .current-week{ box-shadow: inset 0 0 0 2px #c7d2fe; }
        .needs-attention{ background:#ffebee; }

        /* Dialogs */
        .menu{ position:fixed; z-index:50; background:#fff; border:1px solid var(--grid-border); border-radius:8px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,.12); width:260px; display:none; max-height:min(80vh, 420px); overflow:auto; }
        .menu h4{ margin:0 0 6px; font-size:14px; }
        .menu .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0; flex-wrap:wrap; }
        .menu .danger{ background:#d32f2f; }
        .menu .danger:hover{ background:#b71c1c; }
        .menu .subtle{ background:#e5e7eb; color:#111827; }
        .menu .subtle:hover{ background:#d1d5db; }
        .mini-label{ font-size:12px; color:var(--muted); }
        .mini-input{ width:100%; padding:6px 8px; border:1px solid var(--grid-border); border-radius:6px; }
        .seg{ display:flex; gap:6px; flex-wrap:wrap; }

        /* Wizard modal */
        .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:60; }
        .modal{ background:#fff; border-radius:10px; width:min(560px, 92vw); border:1px solid var(--grid-border); box-shadow:0 12px 28px rgba(0,0,0,.2); }
        .modal .hd{ padding:12px 16px; border-bottom:1px solid var(--grid-border); font-weight:700; }
        .modal .bd{ padding:14px; display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto; }
        .modal .ft{ padding:12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid var(--grid-border); }
        .rowx{ display:flex; flex-direction:column; gap:6px; }
        .chip{ background:#eef2f7; border:1px solid var(--grid-border); padding:4px 8px; border-radius:16px; font-size:12px; cursor:pointer; }
        .chip input{ margin-right:6px; }
        .muted{ color:var(--muted); font-size:13px; }

        /* Add a little spacing for inline time selects */
        .time-selects{ display:flex; gap:6px; align-items:center; }
        .time-selects select{ padding:6px 8px; border:1px solid var(--grid-border); border-radius:6px; }

        .is-hidden{ display:none !important; }
        .emp-btn.active{ background: var(--brand); color:#fff; border-color: var(--brand); }
    </style>
</head>
<body>
<header>
    <nav class="nav">
        <div class="left">
            <span class="logo">Care Calendar</span>
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('employees') }}">Employees</a>
            <a href="{{ url_for('shifts') }}">Shifts</a>
            <a href="{{ url_for('attendance') }}">Attendance</a>
            <a href="{{ url_for('tasks') }}">Tasks</a>
            <a href="{{ url_for('performance') }}">Performance</a>
            <a href="{{ url_for('hours_report') }}">Hours</a>
        </div>
        <div class="right">
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>
</header>
<main>
    <section class="card section">
        <h1>Shift Scheduling</h1>
        <div class="rowx">
            <div class="seg">
              <button class="btn" id="btnNewShift">New Shift</button>
              <button class="btn" id="btnSelectMode">Select shifts</button>
              <button class="btn danger hidden" id="btnDeleteSelected">Delete selected (0)</button>
            </div>
            <form id="addShiftForm" action="{{ url_for('shifts') }}" method="post" onsubmit="return validateShiftForm()">
                <input type="hidden" id="employee_id_select" name="employee_id" required>
                <input type="hidden" id="shift_time_input" name="shift_time" required>
                <input type="hidden" id="end_time_input" name="end_time">
                <input type="hidden" id="repeat_until_input" name="repeat_until">
                <!-- selected_days and repeat_weekly will be injected dynamically -->
                <button class="btn hidden" type="submit" id="addShiftBtn">Add Shift</button>
            </form>
        </div>
    </section>

    <section class="card calendar">
        <div class="cal-head">
            <div class="btn-group">
                <button class="nav-btn" id="prevPeriod" aria-label="Previous">« Prev</button>
                <button class="nav-btn" id="todayBtn" aria-label="Current">Today</button>
                <button class="nav-btn" id="nextPeriod" aria-label="Next">Next »</button>
            </div>
            <div class="btn-group">
                <button class="nav-btn" id="viewMonth">Month</button>
                <button class="nav-btn" id="viewWeek">Week</button>
            </div>
            <div class="month-label" id="periodLabel"></div>
        </div>
        <div class="legend" id="calendarLegend" aria-label="Employee color legend"></div>
        <div class="grid">
            <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
        </div>
        <div class="cells" id="grid"></div>
    </section>

    <div class="menu" id="shiftMenu" role="dialog" aria-modal="true" aria-labelledby="menuTitle" tabindex="-1">
        <h4 id="menuTitle">Shift</h4>
        <div class="row"><button class="btn danger" id="btnDeleteShift">Delete shift</button><button class="btn subtle hidden" id="btnDeleteSeries">Delete series</button></div>
        <div class="row">
            <select id="swapSelect"><option value="">Swap to…</option></select>
            <button class="btn" id="btnSwap">Swap</button>
        </div>
        <!-- Replace bulky inline update UI with a single button that opens a wizard -->
        <div class="row is-hidden" id="editSeriesRow">
            <div class="fullw">
                <div class="mini-label">Series</div>
                <button class="btn" id="btnOpenEditSeries">Edit series…</button>
            </div>
        </div>
        <div class="row">
            <div class="fullw">
                <div class="mini-label">Coverage window</div>
                <div class="seg">
                    <input id="covStart" class="mini-input" type="time" value="09:00" step="900">
                    <input id="covEnd" class="mini-input" type="time" value="21:00" step="900">
                    <button class="btn subtle" id="btnSaveCoverage">Save</button>
                </div>
            </div>
        </div>
        <div class="footer-links">
            <button class="btn subtle" id="btnCloseMenu">Close</button>
        </div>
    </div>

    <!-- Wizard Modal -->
    <div class="overlay" id="wizardOverlay" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
      <div class="modal" id="wizardModal">
        <div class="hd" id="wizTitle">Create Shift</div>
        <div class="bd">
          <div class="step" id="step1">
            <div class="rowx">
              <label>Employee</label>
              <div id="wizEmployeeList" class="seg"></div>
            </div>
          </div>
          <div class="step hidden" id="step2">
            <div class="rowx">
              <label for="wizStartDate">Start date & time</label>
              <div class="time-selects">
                <input type="date" id="wizStartDate" class="mini-input">
                <select id="wizStartHour" aria-label="Start hour">
                  <!-- hours 00-23 -->
                  <option value="">HH</option>
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09" selected>09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="wizStartMin" aria-label="Start minutes">
                  <option value="">MM</option>
                  <option value="00" selected>00</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="45">45</option>
                </select>
              </div>
            </div>
            <div class="rowx">
              <label for="wizEndHour">End time (optional)</label>
              <div class="time-selects">
                <select id="wizEndHour" aria-label="End hour">
                  <option value="">HH</option>
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="wizEndMin" aria-label="End minutes">
                  <option value="">MM</option>
                  <option value="00">00</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="45">45</option>
                </select>
              </div>
            </div>
            <!-- Moved repeat controls into this step to keep all scheduling on one screen -->
            <div class="rowx">
              <label><input type="checkbox" id="wizRepeat"> Repeat weekly</label>
            </div>
            <div class="rowx hidden" id="wizDaysCtn">
              <label>Weekdays</label>
              <div class="seg" id="wizDays"></div>
            </div>
            <div class="rowx hidden" id="wizUntilCtn">
              <label>Repeat until (optional)</label>
              <input type="date" id="wizUntil" class="mini-input">
              <div class="muted">Defaults to end of year if empty.</div>
            </div>
          </div>
          <!-- step3 becomes the Review step -->
          <div class="step hidden" id="step3">
            <div class="rowx">
              <strong>Review</strong>
              <div id="wizReview" class="muted"></div>
            </div>
          </div>
          <!-- step4 removed -->
        </div>
        <div class="ft">
          <button class="btn subtle" id="wizCancel">Cancel</button>
          <button class="btn hidden" id="wizBack">Back</button>
          <button class="btn" id="wizNext">Next</button>
        </div>
      </div>
    </div>

    <!-- Edit Series Wizard Modal -->
    <div class="overlay is-hidden" id="editSeriesOverlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal" id="editSeriesModal">
        <div class="hd" id="editTitle">Edit Series</div>
        <div class="bd">
          <div class="step" id="eStep1">
            <div class="rowx">
              <label>Scope</label>
              <div class="muted">Changes apply to future occurrences in this series starting this week.</div>
            </div>
            <div class="rowx">
              <label for="eEmployee">Reassign caregiver (optional)</label>
              <select id="eEmployee"><option value="">Keep current</option></select>
            </div>
          </div>
          <div class="step hidden" id="eStep2">
            <div class="rowx">
              <label>Start time</label>
              <div class="time-selects">
                <select id="eStartHour" aria-label="Start hour">
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="eStartMin" aria-label="Start minutes">
                  <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>
            <div class="rowx">
              <label>End time (optional)</label>
              <div class="time-selects">
                <select id="eEndHour" aria-label="End hour">
                  <option value="">HH</option>
                  <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                </select>
                <span>:</span>
                <select id="eEndMin" aria-label="End minutes">
                  <option value="">MM</option>
                  <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>
          </div>
          <div class="step hidden" id="eStep3">
            <div class="rowx">
              <label>Weekdays</label>
              <div class="seg" id="eDays"></div>
            </div>
          </div>
          <div class="step hidden" id="eStep4">
            <div class="rowx">
              <label>Repeat until (optional)</label>
              <input type="date" id="eUntil" class="mini-input">
              <div class="muted">Defaults to end of year if empty.</div>
            </div>
          </div>
          <div class="step hidden" id="eStep5">
            <div class="rowx">
              <strong>Review</strong>
              <div id="eReview" class="muted"></div>
            </div>
          </div>
        </div>
        <div class="ft">
          <button class="btn subtle" id="eCancel">Cancel</button>
          <button class="btn hidden" id="eBack">Back</button>
          <button class="btn" id="eNext">Next</button>
        </div>
      </div>
    </div>
</main>

<script id="shifts-data" type="application/json">{{ shifts | tojson }}</script>
<script id="employees-data" type="application/json">{{ employees | tojson }}</script>
<script>
// --- Utilities ---
function pad2(n){ return String(n).padStart(2,'0'); }
function localDateStr(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function startOfWeek(d){ const x=new Date(d); const w=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-w); return x; }
function startOfMonth(d){ const x=new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function hashString(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } return Math.abs(h); }
function hslToHex(h,s,l){ s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l); const f=n=> l - a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))); const toHex=x=> Math.round(x*255).toString(16).padStart(2,'0'); return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`; }
function colorForName(name){ const h=hashString(name)%360; return hslToHex(h,55,60); }
function contrast(hex){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); const yiq=(r*299+g*587+b*114)/1000; return yiq>=140?'#000':'#fff'; }
// Ensure form validation handler exists (wizard handles validation already)
function validateShiftForm(){ return true; }

// --- Data ---
const shiftsData = JSON.parse(document.getElementById('shifts-data').textContent);
const employeesData = JSON.parse(document.getElementById('employees-data').textContent);
const API = {
  deleteShift: "{{ url_for('api_delete_shift') }}",
  deleteSeries: "{{ url_for('api_delete_series') }}",
  swapShift: "{{ url_for('api_swap_shift') }}",
  updateSeries: "{{ url_for('api_update_series') }}"
};

// Pre-index shifts by YYYY-MM-DD for faster rendering
function buildDayIndex(shifts){
  const idx = {};
  for(const s of shifts){
    const day = s.shift_time.slice(0,10);
    (idx[day] ||= []).push(s);
  }
  return idx;
}
const dayIndex = buildDayIndex(shiftsData);

// Coverage prefs
function getCov(){ try{ const s=localStorage.getItem('cov'); if(!s) return { a:540, b:1260 }; const {a,b}=JSON.parse(s); return { a, b }; }catch{ return { a:540, b:1260 }; } }
function setCov(a,b){ localStorage.setItem('cov', JSON.stringify({a,b})); }
function minsFromHHMM(t){ const [hh,mm]=t.split(':').map(x=>parseInt(x,10)||0); return hh*60+mm; }

// --- Legend ---
function buildLegend(){
  const legend = document.getElementById('calendarLegend'); legend.innerHTML='';
  const names=[...new Set(shiftsData.map(s=>s.name))].sort((a,b)=>a.localeCompare(b));
  names.forEach(n=>{ const color=colorForName(n); const item=document.createElement('div'); item.className='legend-item'; const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=color; const label=document.createElement('span'); label.textContent=n; item.append(sw,label); legend.appendChild(item); });
}

// --- Views ---
let view = (function(){
  const saved = localStorage.getItem('view');
  if(saved) return saved;
  const v = window.innerWidth < 800 ? 'week' : 'month';
  localStorage.setItem('view', v);
  return v;
})();
let anchor = new Date();

function render(){
  if(view==='month') buildMonth(); else buildWeek();
}

function buildMonth(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const today=new Date(anchor);
  const shown=new Date(today.getFullYear(), today.getMonth(), 1);
  const monthStart=startOfMonth(shown);
  const firstCell=startOfWeek(monthStart); // Monday alignment
  const label=document.getElementById('periodLabel'); label.textContent = shown.toLocaleDateString(undefined,{month:'long', year:'numeric'});

  const currentWeekStart=startOfWeek(new Date());
  for(let i=0;i<42;i++) renderDayCell(addDays(firstCell,i), shown.getMonth(), currentWeekStart, grid);
}

function buildWeek(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const weekStart=startOfWeek(anchor);
  const label=document.getElementById('periodLabel');
  const weekEnd=addDays(weekStart,6);
  label.textContent = `${weekStart.toLocaleDateString(undefined,{month:'short',day:'numeric'})} – ${weekEnd.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
  for(let i=0;i<7;i++) renderDayCell(addDays(weekStart,i), weekStart.getMonth(), weekStart, grid);
}

function renderDayCell(day, shownMonth, currentWeekStart, grid){
  const cell=document.createElement('div'); cell.className='cell';
  if(day.getMonth()!==shownMonth) cell.classList.add('dim');
  const isCurrentWeek = startOfWeek(day).getTime()===currentWeekStart.getTime();
  if(isCurrentWeek) cell.classList.add('current-week');

  const dateTag=document.createElement('div'); dateTag.className='date-tag'; dateTag.textContent=day.getDate(); cell.appendChild(dateTag);
  const pills=document.createElement('div'); pills.className='pills'; cell.appendChild(pills);

  const dayStr=localDateStr(day);
  const items = dayIndex[dayStr] || [];
  const dayShifts = items.map(s=>({
      id:s.id, name:s.name, start:new Date(s.shift_time), end: s.end_time ? new Date(`${dayStr}T${s.end_time.slice(11,16)}`) : null, series_id:s.series_id, employee_id:s.employee_id
  }));

  // Coverage gap check using configurable window
  const cov=getCov(); const ATT_START=cov.a, ATT_END=cov.b;
  let intervals=[];
  for(const sh of dayShifts){
      const st=sh.start.getHours()*60 + sh.start.getMinutes();
      const et=sh.end ? sh.end.getHours()*60 + sh.end.getMinutes() : (st+60);
      const a=Math.max(ATT_START, st), b=Math.min(ATT_END, et);
      if(b>a) intervals.push([a,b]);
  }
  intervals.sort((x,y)=>x[0]-y[0]);
  let merged=[]; for(const iv of intervals){ if(!merged.length || iv[0]>merged[merged.length-1][1]) merged.push(iv); else merged[merged.length-1][1]=Math.max(merged[merged.length-1][1], iv[1]); }
  let covered=0; merged.forEach(([a,b])=> covered+= (b-a));
  if(covered < (ATT_END-ATT_START)){
      const badge=document.createElement('span'); badge.className='gap-badge'; badge.textContent='Coverage gap'; cell.classList.add('needs-attention'); cell.appendChild(badge);
  }

  dayShifts.forEach(sh=>{
      const color=colorForName(sh.name); const text=contrast(color);
      const pill=document.createElement('div'); pill.className='pill'; pill.style.background=color; pill.style.color=text;
      const timelabel = `${pad2(sh.start.getHours())}:${pad2(sh.start.getMinutes())}${sh.end? '–'+pad2(sh.end.getHours())+':'+pad2(sh.end.getMinutes()): ''}`;
      pill.innerHTML = `<span>${timelabel} ${sh.name}</span>`;
      pill.dataset.shiftId=sh.id; pill.dataset.seriesId=sh.series_id||''; pill.dataset.employeeId=sh.employee_id;
      pill.addEventListener('click', (e)=>{ if(selectionMode){ toggleSelect(pill, sh.id, sh.series_id); } else { openMenu(e, sh); } });
      pills.appendChild(pill);
  });

  grid.appendChild(cell);
}

// --- Selection mode & batch delete ---
let selectionMode=false;
const selected=new Set();
const selectedMap=new Map(); // id -> series_id|null
function updateDeleteSelectedLabel(){ const b=document.getElementById('btnDeleteSelected'); if(b) b.textContent=`Delete selected (${selected.size})`; }
function toggleSelect(pill, id, seriesId){ if(selected.has(id)){ selected.delete(id); selectedMap.delete(id); pill.classList.remove('selected'); } else { selected.add(id); selectedMap.set(id, seriesId||null); pill.classList.add('selected'); } updateDeleteSelectedLabel(); }

document.getElementById('btnSelectMode').addEventListener('click', ()=>{
  selectionMode = !selectionMode;
  document.getElementById('btnDeleteSelected').classList.toggle('hidden', !selectionMode);
  document.getElementById('btnSelectMode').textContent = selectionMode ? 'Cancel selection' : 'Select shifts';
  selected.clear(); selectedMap.clear(); updateDeleteSelectedLabel();
  document.querySelectorAll('.pill.selected').forEach(el=> el.classList.remove('selected'));
});

document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{
  if(!selected.size) return alert('No shifts selected');
  const hasSeries = [...selectedMap.values()].some(v=>!!v);
  let deleteSeriesToo=false;
  if(hasSeries){
    deleteSeriesToo = confirm('Some selected shifts are part of a series. Press OK to delete entire series for those; Cancel to delete only selected occurrences.');
  }
  try{
    const ops=[];
    if(deleteSeriesToo){
      const seriesIds=[...new Set([...selectedMap.values()].filter(Boolean))];
      seriesIds.forEach(sid=> ops.push(postJSON(API.deleteSeries, { series_id: sid })));
      const singles=[...selectedMap.entries()].filter(([id,sid])=>!sid).map(([id])=>id);
      singles.forEach(id=> ops.push(postJSON(API.deleteShift, { shift_id: id })));
    } else {
      [...selected].forEach(id=> ops.push(postJSON(API.deleteShift, { shift_id: id })));
    }
    await Promise.all(ops);
    location.reload();
  }catch(e){ alert('Failed to delete selected: '+e.message); }
});

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && selectionMode){ document.getElementById('btnSelectMode').click(); }});

// --- Menu ---
let currentShift=null;
const menu=document.getElementById('shiftMenu');
let menuAnchor = { x: 0, y: 0 };
function openMenu(evt, sh){
  currentShift=sh;
  document.getElementById('menuTitle').textContent = `${sh.name} • ${sh.start.toLocaleString()}`;
  const btnSeries=document.getElementById('btnDeleteSeries'); btnSeries.classList.toggle('hidden', !sh.series_id);
  // Show/hide Edit Series row based on whether this is part of a series
  const editRow = document.getElementById('editSeriesRow'); if(editRow){ editRow.classList.toggle('is-hidden', !sh.series_id); }
  const sel=document.getElementById('swapSelect'); sel.innerHTML='<option value="">Swap to…</option>' + employeesData.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
  const cov=getCov(); document.getElementById('covStart').value = `${pad2(Math.floor(cov.a/60))}:${pad2(cov.a%60)}`; document.getElementById('covEnd').value = `${pad2(Math.floor(cov.b/60))}:${pad2(cov.b%60)}`;
  menuAnchor = { x: evt.clientX, y: evt.clientY };
  positionMenuNear(menuAnchor.x, menuAnchor.y);
  // focus for accessibility
  menu.setAttribute('tabindex','-1');
  menu.focus();
}
function closeMenu(){ menu.style.display='none'; currentShift=null; }

async function postJSON(url, payload){
  const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  if(!res.ok){ const t=await res.text(); throw new Error(t); }
  return res.json();
}

// --- Menu ---
// Replace Delete button node to clear any prior listeners, then attach series-aware delete
(function(){
  const oldBtn = document.getElementById('btnDeleteShift');
  if(oldBtn){
    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);
    newBtn.addEventListener('click', async ()=>{
      if(!currentShift) return;
      try{
        if(currentShift.series_id){
          const all = confirm('This shift is part of a series. Press OK to delete the entire series, or Cancel to delete only this occurrence.');
          if(all){ await postJSON(API.deleteSeries, { series_id: currentShift.series_id }); }
          else { await postJSON(API.deleteShift, { shift_id: currentShift.id }); }
        } else {
          await postJSON(API.deleteShift, { shift_id: currentShift.id });
        }
        location.reload();
      }catch(e){ alert('Failed to delete: '+e.message); }
    });
  }
})();

document.getElementById('btnDeleteSeries').addEventListener('click', async ()=>{
  if(!currentShift || !currentShift.series_id) return; if(!confirm('Delete the entire series?')) return;
  try{ await postJSON(API.deleteSeries, { series_id: currentShift.series_id }); location.reload(); }catch(e){ alert('Failed to delete series: '+e.message); }
});

document.getElementById('btnSwap').addEventListener('click', async ()=>{
  if(!currentShift) return; const sel=document.getElementById('swapSelect'); const val=sel.value; if(!val) return alert('Select a caregiver to swap to');
  try{ await postJSON(API.swapShift, { shift_id: currentShift.id, new_employee_id: parseInt(val,10) }); location.reload(); }catch(e){ alert('Failed to swap: '+e.message); }
});

// Remove legacy inline series update handler if element not present
(function(){
  const btn = document.getElementById('btnUpdateSeries');
  if(btn){
    btn.addEventListener('click', async ()=>{
      if(!currentShift || !currentShift.series_id) return alert('Series not available');
      const time = document.getElementById('seriesTime').value; if(!time) return alert('Time required');
      const end = document.getElementById('seriesEnd').value; const until = document.getElementById('seriesUntil').value || null;
      const wds = Array.from(document.querySelectorAll('.series-wd:checked')).map(el=>parseInt(el.value,10)); if(!wds.length) return alert('Select weekdays');
      const startDate = localDateStr(startOfWeek(currentShift.start));
      try{ await postJSON(API.updateSeries, { series_id: currentShift.series_id, start_date: startDate, time, end_time:end||null, weekdays:wds, repeat_until: until }); location.reload(); }catch(e){ alert('Failed to update series: '+e.message); }
    });
  }
})();

document.getElementById('btnSaveCoverage').addEventListener('click', ()=>{
  const a = minsFromHHMM(document.getElementById('covStart').value||'09:00');
  const b = minsFromHHMM(document.getElementById('covEnd').value||'21:00');
  if(b<=a) return alert('Coverage end must be after start');
  setCov(a,b); closeMenu(); render();
});

document.getElementById('btnCloseMenu').addEventListener('click', closeMenu);
window.addEventListener('click', (e)=>{ if(menu.style.display==='block' && !menu.contains(e.target) && !e.target.classList.contains('pill')) closeMenu(); });
window.addEventListener('resize', ()=>{ if(menu.style.display==='block'){ positionMenuNear(menuAnchor.x, menuAnchor.y); } });

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(menu.style.display==='block') closeMenu();
    else if(overlay && overlay.style.display==='flex') closeWizard();
    else if(editOverlay && !editOverlay.classList.contains('is-hidden')) closeEditWizard();
  }
});

// --- Wizard ---
const overlay = document.getElementById('wizardOverlay');
const wiz = { step:1, employeeId:null, start:null, end:null, repeat:false, days:new Set(), until:null };

function showStep(n){
  wiz.step=n;
  for(let i=1;i<=3;i++) document.getElementById('step'+i).classList.toggle('hidden', i!==n);
  document.getElementById('wizBack').classList.toggle('hidden', n===1);
  document.getElementById('wizNext').textContent = (n===3?'Create':'Next');
  if(n===3) buildReview();
}

function openWizard(){
  // Build employee button list
  const list = document.getElementById('wizEmployeeList');
  if(list){
    list.innerHTML = '';
    employeesData.forEach(e=>{
      const b=document.createElement('button');
      b.type='button'; b.className='chip emp-btn'; b.textContent=e.name; b.dataset.id=e.id; b.setAttribute('aria-pressed','false');
      b.addEventListener('click', ()=>{
        // clear previous selection
        list.querySelectorAll('.emp-btn').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
        b.classList.add('active'); b.setAttribute('aria-pressed','true'); wiz.employeeId = String(e.id);
      });
      list.appendChild(b);
    });
  }
  // Build weekdays once
  const daysCtn=document.getElementById('wizDays');
  if(daysCtn && !daysCtn.dataset.built){
    const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    labels.forEach((lb,idx)=>{ const lab=document.createElement('label'); lab.className='chip'; lab.innerHTML=`<input type="checkbox" value="${idx}"> ${lb}`; daysCtn.appendChild(lab); });
    daysCtn.dataset.built='1';
  }
  overlay.style.display='flex';
  setTimeout(()=>{ try{ const firstBtn=list && list.querySelector('.emp-btn'); if(firstBtn) firstBtn.focus(); }catch{} }, 0);
  showStep(1);
}
function closeWizard(){ overlay.style.display='none'; }

function buildReview(){
  const emp = employeesData.find(e=> String(e.id)===String(wiz.employeeId));
  const startStr = wiz.start ? new Date(wiz.start).toLocaleString() : 'Not set';
  const endStr = wiz.end || 'None';
  let rec='No'; if(wiz.repeat){ const days=[...wiz.days].sort().map(d=>['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d]).join(', '); rec=`Yes • ${days || 'Base day'}${wiz.until? ' • until '+wiz.until: ''}`; }
  document.getElementById('wizReview').textContent = `${emp?emp.name:'(none)'} • ${startStr} • End ${endStr} • Repeat ${rec}`;
}

// Compute start/end from selects (15-minute increments enforced)
function updateStartFromControls(){ const d=document.getElementById('wizStartDate').value; const hh=document.getElementById('wizStartHour').value; const mm=document.getElementById('wizStartMin').value; wiz.start = (d && hh && mm) ? `${d}T${hh}:${mm}` : null; }
function updateEndFromControls(){ const hh=document.getElementById('wizEndHour').value; const mm=document.getElementById('wizEndMin').value; wiz.end = (hh && mm) ? `${hh}:${mm}` : null; }

// Buttons
 document.getElementById('btnNewShift').addEventListener('click', openWizard);
 document.getElementById('wizCancel').addEventListener('click', closeWizard);
 document.getElementById('wizBack').addEventListener('click', ()=> showStep(Math.max(1, wiz.step-1)) );
 document.getElementById('wizNext').addEventListener('click', ()=>{
    if(wiz.step===1){ if(!wiz.employeeId) return alert('Select an employee'); showStep(2); return; }
    if(wiz.step===2){
      updateStartFromControls(); updateEndFromControls();
      if(!wiz.start) return alert('Pick a start date & time');
      if(wiz.end){ const st=new Date(wiz.start); const [eh,em]=wiz.end.split(':'); const et=new Date(wiz.start); et.setHours(parseInt(eh,10), parseInt(em,10), 0, 0); if(et<=st) return alert('End time must be after start'); }
      showStep(3); return;
    }
    if(wiz.step===3){
      const form=document.getElementById('addShiftForm');
      document.getElementById('employee_id_select').value = wiz.employeeId;
      document.getElementById('shift_time_input').value = wiz.start;
      document.getElementById('end_time_input').value = wiz.end || '';
      document.getElementById('repeat_until_input').value = wiz.until || '';
      // cleanup previous dynamic fields
      [...form.querySelectorAll('input[name="selected_days"]'), ...form.querySelectorAll('input[name="repeat_weekly"]')].forEach(n=>n.remove());
      if(wiz.repeat){ const rw=document.createElement('input'); rw.type='hidden'; rw.name='repeat_weekly'; rw.value='on'; form.appendChild(rw); wiz.days.forEach(d=>{ const hid=document.createElement('input'); hid.type='hidden'; hid.name='selected_days'; hid.value=String(d); form.appendChild(hid); }); }
      form.requestSubmit(); closeWizard();
    }
  });

// New event wiring for selects
['wizStartDate','wizStartHour','wizStartMin'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', updateStartFromControls); });
['wizEndHour','wizEndMin'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', updateEndFromControls); });

// Repeat controls (now on step2)
document.getElementById('wizRepeat').addEventListener('change', (e)=>{ wiz.repeat = e.target.checked; document.getElementById('wizDaysCtn').classList.toggle('hidden', !wiz.repeat); document.getElementById('wizUntilCtn').classList.toggle('hidden', !wiz.repeat); });
document.getElementById('wizDays').addEventListener('change', (e)=>{ if(e.target && e.target.type==='checkbox'){ const v=parseInt(e.target.value,10); if(e.target.checked) wiz.days.add(v); else wiz.days.delete(v); } });
document.getElementById('wizUntil').addEventListener('change', (e)=>{ wiz.until = e.target.value || null; });

// After DOM defined: prefill wiz.start from defaults on open
function prefillWizardDefaults(){ const hSel=document.getElementById('wizStartHour'); const mSel=document.getElementById('wizStartMin'); if(hSel && !hSel.value) hSel.value='09'; if(mSel && !mSel.value) mSel.value='00'; }
const _openWizard = openWizard; openWizard = function(){ _openWizard(); prefillWizardDefaults(); if(typeof updateStartFromControls==='function') updateStartFromControls(); };

// --- Init calendar controls and first render ---
(function initCalendar(){
  try{ buildLegend(); }catch(e){ console.error('Legend build failed', e); }
  try{ render(); }catch(e){ console.error('Render failed', e); }
  const prev = document.getElementById('prevPeriod');
  const next = document.getElementById('nextPeriod');
  const today = document.getElementById('todayBtn');
  const mbtn = document.getElementById('viewMonth');
  const wbtn = document.getElementById('viewWeek');
  if(prev) prev.addEventListener('click', ()=>{ anchor = (view==='month') ? new Date(anchor.getFullYear(), anchor.getMonth()-1, 1) : addDays(anchor, -7); render(); });
  if(next) next.addEventListener('click', ()=>{ anchor = (view==='month') ? new Date(anchor.getFullYear(), anchor.getMonth()+1, 1) : addDays(anchor, 7); render(); });
  if(today) today.addEventListener('click', ()=>{ anchor = new Date(); render(); });
  if(mbtn) mbtn.addEventListener('click', ()=>{ view='month'; localStorage.setItem('view','month'); render(); });
  if(wbtn) wbtn.addEventListener('click', ()=>{ view='week'; localStorage.setItem('view','week'); render(); });
})();
</script>
</body>
</html>